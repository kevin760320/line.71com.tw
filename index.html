function doPost(e) {
  try {
    const data =e.parameter;

    const brevoApiKey = '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';  // ← 這裡請換成你的金鑰

    // 確保 base64 沒有前綴
    if (!data.image_data || data.image_data.startsWith("data:image")) {
      throw new Error("圖片格式錯誤，請確認 base64 無前綴");
    }

    const toList = [{
      email: data.to_email,
      name: data.to_name
    }];

    const payload = {
      sender: {
        name: data.from_name || "表單系統",
        email: "xiaxianglong8@gmail.com"  // ← 這是你 Brevo 驗證過的寄件人
      },
      to: toList,
      subject: "來自網站的表單資料",
      htmlContent: `<p>以下為使用者提交的表單截圖：</p><img src="cid:formImage" />`,
      attachment: [{
        content: data.image_data,  // 純 base64 圖片資料
        name: "form.png",
        type: "image/png",
        contentId: "formImage"
      }]
    };

    const options = {
      method: "post",
      contentType: "application/json",
      headers: {
        "api-key": brevoApiKey,
        "accept": "application/json"
      },
      payload: JSON.stringify(payload)
    };

    const response = UrlFetchApp.fetch("https://api.brevo.com/v3/smtp/email", options);
    const responseText = response.getContentText();

    Logger.log("Brevo 回應：" + responseText);

    return ContentService
      .createTextOutput(JSON.stringify({ status: "success", response: responseText }))
      .setMimeType(ContentService.MimeType.JSON);

  } catch (err) {
    Logger.log("發生錯誤：" + err.message);
    return ContentService
      .createTextOutput(JSON.stringify({ status: "error", message: err.message }))
      .setMimeType(ContentService.MimeType.JSON);
  }
}

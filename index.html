<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <title>寄送簽名圖片表單</title>
</head>
<body>
  <h2>寄送簽名圖片表單</h2>

  <!-- 表單 -->
  <form id="sendForm">
    <input type="hidden" name="from_name" value="Kevin 測試系統">
    <input type="hidden" name="to_email" value="kevin.hsia@icloud.com">
    <input type="hidden" name="to_name" value="Kevin">
    <input type="hidden" name="image_data" id="image_data">
    <button type="button" id="sendButton" onclick="captureAndSubmit()">產生簽名圖並寄出</button>
  </form>

  <!-- 預覽區域 -->
  <div id="signatureArea" style="border: 1px solid black; padding: 10px; width: 300px;">
    <p>這裡是簽名預覽區域</p>
    <img id="signaturePreview" src="" style="max-width: 100%;">
  </div>

  <!-- 載入 html2canvas -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

  <script>
    // 自 localStorage 載入簽名圖片
    window.addEventListener('focus', () => {
      const dataUrl = localStorage.getItem('signatureData');
      if (dataUrl) document.getElementById('signaturePreview').src = dataUrl;
    });

    // 供簽名頁用 postMessage 傳回資料時觸發（支援跨頁自動更新）
    window.addEventListener("message", function(event) {
      if (event.data?.type === "signatureSaved") {
        const dataUrl = localStorage.getItem("signatureData");
        if (dataUrl) {
          document.getElementById("signaturePreview").src = dataUrl;
        }
      }
    });

    // 截圖並送出表單
    function captureAndSubmit() {
      const button = document.getElementById("sendButton");
      button.disabled = true;
      button.innerText = "寄送中...";

      const container = document.getElementById("signatureArea");
      html2canvas(container).then(canvas => {
        const base64Image = canvas.toDataURL("image/png").split(",")[1];
        const formData = new FormData();
        formData.append("from_name", "Kevin 測試系統");
        formData.append("to_email", "kevin.hsia@icloud.com");
        formData.append("to_name", "Kevin");
        formData.append("image_data", base64Image);

        fetch("https://script.google.com/macros/s/AKfycbxf5DiQUJ5EbZ7dsxK_SduJMHBql5yw9R5iK0FaHrhO_VrF_PMxzBk9KN_MmA8b7_67/exec", {
          method: "POST",
          body: formData
        })
        .then(response => response.text())
        .then(result => {
          alert("簽名圖片已成功寄出！");
          button.disabled = false;
          button.innerText = "產生簽名圖並寄出";
        })
        .catch(error => {
          console.error("寄送失敗:", error);
          alert("寄送失敗，請稍後再試！");
          button.disabled = false;
          button.innerText = "產生簽名圖並寄出";
        });
      });
    }
  </script>
</body>
</html>